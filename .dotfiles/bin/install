#!/usr/bin/env zsh

install() {
  if test -d "$HOME/.git"; then
    echo "$HOME/.git directory already exists. Exiting..."
    exit 1
  fi

  cd $HOME

  git clone --bare "https://github.com/tregusti/dotfiles.git" ".git" || exit 1

  confirm

  # Convert repo from bare to normal.
  git config --local --bool core.bare false
  # We need a custom name for local ignore file, since ~/.gitignore is
  # global for the whole system.
  git config --local core.excludesFile .dotfiles.gitignore
  # Pull in all files from repo into ~.
  git reset --hard || exit 2
  # Setup submodules
  git submodule update --init || exit 3
  # Remove and readd remote since a remote for a bare repo has some issues.
  # Like no master branch it seems... Check this out sometime?
  git remote remove origin
  git remote add origin "https://github.com/tregusti/dotfiles.git"

  echo "Installation complete."
  echo
  echo "To update, just do:"
  echo "  cd ~ && git pull --rebase"
}

confirm() {
  echo "If you continue, all files in your HOME directory"
  echo "matching the following names will be overwritten:"
  echo
  git ls-files | sed 's#/.*##' | uniq
  echo

  local OK
  read -n 1 -e -p "Do you want to continue [y,N]: " OK

  if [[ "$OK" != "y" & "$OK" != "Y" ]]; then
    echo "Ok, exiting..."
    exit 9
  fi
}

install
